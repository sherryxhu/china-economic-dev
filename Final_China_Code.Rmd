---
title: "Final_China_Code"
author: "Daniel Zhou, Sherry Hu, Peining Yang, Siyi Xu"
date: "6/3/2020"
output: html_document
---

```{r library}
# libraries that need to be installed and loaded
library(tidyverse)
library(dplyr)
library(reshape2)
library(ggplot2)
library(lme4)
library(lattice)
library(caret)
library(monomvn)
library(ineq)
library(car)
library(knitr)
library(reshape)
library(kableExtra)
library(lmerTest)
```

# Data Preparation

```{r data_pre}
# read in data
require(haven)
sashhinc=read_sas("hhinc_10.sas7bdat")

# let's make this more interpretable by letting 1989 be year 0
# also let's convert income to thousands of yuan and remove missing for hhincpc_cpi
sashhinc$cyear=sashhinc$WAVE-1989
sashhinc$thousands=sashhinc$hhincpc_cpi/1000
sashhinc = sashhinc[!is.na(sashhinc$hhincpc_cpi), ]

# replace NAs w/ null
sashhinc[is.na(sashhinc)] = 0
sashhinc_trimmed = sashhinc
# shift variables to positive in the case we want to use a log transform 
sashhinc$thousands_shifted=sashhinc$thousands - (min(sashhinc$thousands)-1)
sashhinc$log_thousands_shifted = log(sashhinc$thousands_shifted)


# change to categorical variables
sashhinc$urban <- as.factor(sashhinc$urban)
sashhinc$hhid <- as.factor(sashhinc$hhid)
sashhinc$t1 <- as.factor(sashhinc$t1)

# refactor t1
sashhinc$t1 <- factor(sashhinc$t1, levels = c("21", "11", "23", "31", "32", "37", "41", "42", "43", "45", "52", "55"))

```

```{r data_summary}
# take a peek at dataset
colnames(sashhinc)
summary(sashhinc)
```

```{r data_cleaning}
# select variables we need for df
df = dplyr::select(sashhinc,
            hhid,
            WAVE,
            hhinc_cpi, 
            hhincpc_cpi, 
            HHBUS, 
            HHBUSimp, 
            HHFARM, 
            HHFARMimp, 
            HHFISH, 
            HHFISHimp, 
            hhgard, 
            HHGARDimp,
            HHLVST,
            HHLVSTimp,
            hhNRwage,
            HHNRWAGEimp,
            HHOTHR,
            HHOTHRimp,
            HHRETIRE,
            HHRETIREimp,
            HHSUB,
            HHSUBimp,
            t1,
            urban,
            thousands,
            cyear,
            thousands_shifted,
            log_thousands_shifted)

names(df)<- toupper(names(df))

df = df[!is.na(df$HHINCPC_CPI), ]

#add primary income source variable
df <- df %>% 
        mutate(Primary = colnames(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")])[apply(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")], 1, which.max)])

#add variable indicating whether household receives income from specific sources
df <- df %>% 
  mutate(business_ind = factor(as.numeric(HHBUS != 0)),
         farm_ind = factor(as.numeric(HHFARM != 0)),
         fish_ind = factor(as.numeric(HHFISH != 0)),
         gard_ind = factor(as.numeric(HHGARD != 0)),
         lvst_ind = factor(as.numeric(HHLVST != 0)),
         othr_ind = factor(as.numeric(HHOTHR != 0)),
         retire_ind = factor(as.numeric(HHRETIRE != 0)),
         sub_ind = factor(as.numeric(HHSUB != 0)))

df <- df %>% 
  mutate(T1_11_ind = factor(T1 == 11),
         T1_21_ind = factor(T1 == 21),
         T1_23_ind = factor(T1 == 23),
         T1_31_ind = factor(T1 == 31),
         T1_32_ind = factor(T1 == 32),
         T1_37_ind = factor(T1 == 37),
         T1_41_ind = factor(T1 == 41),
         T1_42_ind = factor(T1 == 42),
         T1_43_ind = factor(T1 == 43),
         T1_45_ind = factor(T1 == 45),
         T1_52_ind = factor(T1 == 52),
         T1_55_ind = factor(T1 == 55))

# make T/F -> 1/0
df$T1_11_ind <- as.factor(as.integer(as.logical(df$T1_11_ind)))
df$T1_21_ind <- as.factor(as.integer(as.logical(df$T1_21_ind)))
df$T1_23_ind <- as.factor(as.integer(as.logical(df$T1_23_ind)))
df$T1_31_ind <- as.factor(as.integer(as.logical(df$T1_31_ind)))
df$T1_32_ind <- as.factor(as.integer(as.logical(df$T1_32_ind)))
df$T1_37_ind <- as.factor(as.integer(as.logical(df$T1_37_ind)))
df$T1_41_ind <- as.factor(as.integer(as.logical(df$T1_41_ind)))
df$T1_42_ind <- as.factor(as.integer(as.logical(df$T1_42_ind)))
df$T1_43_ind <- as.factor(as.integer(as.logical(df$T1_43_ind)))
df$T1_45_ind <- as.factor(as.integer(as.logical(df$T1_45_ind)))
df$T1_52_ind <- as.factor(as.integer(as.logical(df$T1_52_ind)))
df$T1_55_ind <- as.factor(as.integer(as.logical(df$T1_55_ind)))

names(df)<- toupper(names(df))
df$T1 = as.factor(df$T1)


head(df)

lower = quantile(df$THOUSANDS, 0.001)
upper = quantile(df$THOUSANDS, 0.999)
df_trimmed = subset(df, lower < THOUSANDS & THOUSANDS < upper)

## .1% removed (negative outliers) - put in trimmed df
lower = quantile(df$THOUSANDS, 0.001)
df_trimmed = subset(df, lower < THOUSANDS)
df_trimmed$THOUSANDS_SHIFTED =df_trimmed$THOUSANDS - (min(df_trimmed$THOUSANDS)-1)
df_trimmed$LOG_THOUSANDS_SHIFTED = log(df_trimmed$THOUSANDS_SHIFTED)

# shift df variables by min as well
df$THOUSANDS_SHIFTED =df$THOUSANDS - (min(df$THOUSANDS)-1)
df$LOG_THOUSANDS_SHIFTED = log(df$THOUSANDS_SHIFTED)
```

#Justification for Log Transformation
```{r}
og_income <- df_trimmed %>% 
  dplyr::group_by(WAVE) %>% 
  dplyr::summarise(og_mean_inc = mean(HHINCPC_CPI))
ggplot(og_income, aes(x=WAVE, y=og_mean_inc)) +
  geom_point() +
  labs(title = "Mean Per Capita Household Income by Year",
       x = "Year",
       y = "Yuan")

log_income <- og_income %>% 
  mutate(log_mean_income = log(og_mean_inc))
ggplot(log_income, aes(x=WAVE, y=log_mean_income)) +
  geom_point() +
  labs(title = "Log Mean Per Capita Household Income by Year",
       x = "Year",
       y = "Log(Yuan)")
```


# Initial Model 


```{r initial_Model}
# fit model with main effects
m1 = lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + T1 +  URBAN + BUSINESS_IND + FARM_IND + FISH_IND +  LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1|HHID), data = df_trimmed)
summary(m1)
```

```{r}
qqmath(resid(m1), main="Initial Model QQplot")
plot(m1,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Initial Model Residuals")
hist(df_trimmed$LOG_THOUSANDS_SHIFTED, main="Histogram of log(Thousands_Shifted)", xlab="log(Thousands_Shifted)")
```

The figures indicate a relatively normal distribution of errors and a linear relationship between independent and dependent variables, giving us confidence in our model.

```{r}
vif(m1)
```

the highest VIF value is 1.53 which us confidence in our model



## testing two-way CYEAR interactions 

```{r}
variables_of_interest = c("CYEAR * URBAN", 
                         # "T1_21_IND*CYEAR", # Liaoning Baseline
                         # "T1_11_IND*CYEAR", 
                         "T1_23_IND*CYEAR", 
                        # "T1_31_IND*CYEAR", 
                         "T1_32_IND*CYEAR",
                         "T1_37_IND*CYEAR",
                         "T1_41_IND*CYEAR",
                         "T1_42_IND*CYEAR",
                         "T1_43_IND*CYEAR",
                         "T1_45_IND*CYEAR",
                         "T1_52_IND*CYEAR",
                        # "T1_55_IND*CYEAR",
                          "CYEAR * BUSINESS_IND",
                          "CYEAR * FARM_IND", 
                          "CYEAR * FISH_IND",
                         # "CYEAR * GARD_IND", #GARD Baseline
                          "CYEAR * LVST_IND",
                          "CYEAR * OTHR_IND", 
                          "CYEAR * RETIRE_IND",
                          "CYEAR * SUB_IND")

remaining_variables_of_interest = variables_of_interest

current_variables = c("CYEAR",
                      "URBAN",
                      "T1",
                      "BUSINESS_IND",
                      "FARM_IND", 
                      "FISH_IND",
                      # "GARD_IND",
                      "LVST_IND",
                      "OTHR_IND", 
                      "RETIRE_IND",
                      "SUB_IND",
                      "(1|HHID)")
current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))

while(TRUE){
  print("current baseline")
  print(current_variables)
  # get baseline
  current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
  baseline = lmer(current_formula, data=df_trimmed, REML=FALSE)
  
  # loop through remaining variables of interest and create a new model
  models = c()
  for (var in remaining_variables_of_interest){
    curr_var_loop = c(current_variables, var)
    current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED~ ",paste(curr_var_loop, collapse="+"),sep = ""))
    new_model = lmer(current_formula, data=df_trimmed, REML=FALSE)
    models = c(models, new_model)
  }
  
  # perform anova on baseline and a new model, record the resulting p-value
  p_vals = c()
  for (m in models){
    anova_result = anova(baseline, m)
    p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
  }
  
  # if the smallest p-value is greater than 0.05, stop because no new variable is significant
  if (min(p_vals)>0.05){
    print("no remaining significant variables of interest")
    break
  }
  print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
  
  # add most signficant variable to model
  current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
  
  # remove the most significant variable from search space
  remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
  if (length(remaining_variables_of_interest)==0){
    break
  }
}
```

```{r}
selected_model = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
selected_model
```


# Checking our model selection with lmer: step 
```{r}
library(lmerTest)
m3 = lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR +
            T1 +
            URBAN +
            BUSINESS_IND +
            FARM_IND +
            FISH_IND +
            # GARD_IND + baseline
            LVST_IND +
            OTHR_IND +
            RETIRE_IND +
            SUB_IND +
            (1 | HHID) +
            CYEAR * URBAN +
            # T1_21_IND*CYEAR+ Lianoning- baseline 
		        # T1_11_IND*CYEAR+ Beijing
             T1_23_IND*CYEAR+
            #T1_31_IND*CYEAR+ Shanghai
             T1_32_IND*CYEAR+
             T1_37_IND*CYEAR+
             T1_41_IND*CYEAR+
             T1_42_IND*CYEAR+
             T1_43_IND*CYEAR+
             T1_45_IND*CYEAR+
             T1_52_IND*CYEAR+
            # T1_55_IND*CYEAR+ Chongqing
            CYEAR * BUSINESS_IND +
            CYEAR * FARM_IND +
            CYEAR * FISH_IND +
           # CYEAR * GARD_IND + baseline
            CYEAR * LVST_IND +
            CYEAR * OTHR_IND +
            CYEAR * RETIRE_IND +
            CYEAR * SUB_IND,data=df_trimmed, REML = FALSE)
lmerTest::step(m3,reduce.fixed = FALSE)
```

the only differences were the selection of CYEAR\*FARM_IND and CYEAR\*FISH_IND

```{r}
step_model = lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + T1 + URBAN + BUSINESS_IND + FARM_IND + 
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 | 
    HHID) + CYEAR * URBAN + T1_23_IND * CYEAR + T1_32_IND * CYEAR + 
    T1_37_IND * CYEAR + T1_41_IND * CYEAR + T1_42_IND * CYEAR + 
    T1_43_IND * CYEAR + T1_45_IND * CYEAR + T1_52_IND * CYEAR + 
    CYEAR * BUSINESS_IND + CYEAR * FARM_IND + CYEAR * FISH_IND + 
    CYEAR * LVST_IND + CYEAR * OTHR_IND + CYEAR * RETIRE_IND + 
    CYEAR * SUB_IND, data=df_trimmed)
vif(step_model)
```

## final model
```{r}
model_final_formula = as.formula("LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + 
#T1_21_IND+
T1_11_IND+
T1_23_IND+
T1_31_IND+
T1_32_IND+
T1_37_IND+
T1_41_IND+
T1_42_IND+
T1_43_IND+
T1_45_IND+
T1_52_IND+
T1_55_IND+ 
BUSINESS_IND + 
FARM_IND + 
FISH_IND + 
LVST_IND +
OTHR_IND +
RETIRE_IND + 
SUB_IND + 
(1 | HHID) + 
CYEAR * URBAN + 
T1_23_IND * CYEAR + 
T1_32_IND *  CYEAR + 
T1_37_IND * CYEAR + 
T1_41_IND *  CYEAR + 
T1_42_IND * CYEAR + 
T1_43_IND * CYEAR + 
T1_45_IND * CYEAR + 
T1_52_IND * CYEAR + 
CYEAR * BUSINESS_IND + 
CYEAR * LVST_IND + 
CYEAR * OTHR_IND +
CYEAR * RETIRE_IND +
CYEAR * SUB_IND")

model_final = lmer(model_final_formula, data=df_trimmed)

summary(model_final)
```


```{r}
qqmath(resid(model_final), main="Final Model QQPlot")
plot(model_final,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Final Model Residuals")
```

qqplot and residual plots show that model doesn't appear to violate assumptions

```{r}
vif(model_final)
```

vif values less than 10 demonstrate lack of multicollinearity

## confidence intervals

```{r}
CI_interval = confint(model_final)
exp_CI_interval = exp(CI_interval)
```

## model variants

### cyear^2 is not selected

The following code performs model selection with cyear^2 as a potential variable, but it is not selected. It is commented out because it takes so long to run.

```{r}

# variables_of_interest = c("CYEAR * URBAN", 
#                          # "T1_21_IND*CYEAR", # Liaoning Baseline
#                          # "T1_11_IND*CYEAR", 
#                          "T1_23_IND*CYEAR", 
#                         # "T1_31_IND*CYEAR", 
#                          "T1_32_IND*CYEAR",
#                          "T1_37_IND*CYEAR",
#                          "T1_41_IND*CYEAR",
#                          "T1_42_IND*CYEAR",
#                          "T1_43_IND*CYEAR",
#                          "T1_45_IND*CYEAR",
#                          "T1_52_IND*CYEAR",
#                         # "T1_55_IND*CYEAR",
#                           "CYEAR * BUSINESS_IND",
#                           "CYEAR * FARM_IND", 
#                           "CYEAR * FISH_IND",
#                          # "CYEAR * GARD_IND",
#                           "CYEAR * LVST_IND",
#                           "CYEAR * OTHR_IND", 
#                           "CYEAR * RETIRE_IND",
#                           "CYEAR * SUB_IND",
#                           "CYEAR^2")
# 
# remaining_variables_of_interest = variables_of_interest
# 
# current_variables = c("CYEAR",
#                       "URBAN",
#                       "T1",
#                       "BUSINESS_IND",
#                       "FARM_IND", 
#                       "FISH_IND",
#                       # "GARD_IND",
#                       "LVST_IND",
#                       "OTHR_IND", 
#                       "RETIRE_IND",
#                       "SUB_IND",
#                       "(1|HHID)")
# current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
# 
# while(TRUE){
#   print("current baseline")
#   print(current_variables)
#   # get baseline
#   current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
#   baseline = lmer(current_formula, data=df_trimmed, REML=FALSE)
#   
#   # loop through remaining variables of interest and create a new model
#   models = c()
#   for (var in remaining_variables_of_interest){
#     curr_var_loop = c(current_variables, var)
#     current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED~ ",paste(curr_var_loop, collapse="+"),sep = ""))
#     new_model = lmer(current_formula, data=df_trimmed, REML=FALSE)
#     models = c(models, new_model)
#   }
#   
#   # perform anova on baseline and a new model, record the resulting p-value
#   p_vals = c()
#   for (m in models){
#     anova_result = anova(baseline, m)
#     p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
#   }
#   
#   # if the smallest p-value is greater than 0.05, stop because no new variable is significant
#   if (min(p_vals)>0.05){
#     print("no remaining significant variables of interest")
#     break
#   }
#   print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
#   
#   # add most signficant variable to model
#   current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
#   
#   # remove the most significant variable from search space
#   remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
#   if (length(remaining_variables_of_interest)==0){
#     break
#   }
# }
```

### cyear^3 is not selected

The following code performs model selection with year^3 as a variable of interest. It is ultimately not selected. it has been commented out since it takes so long to run.
```{r}
# variables_of_interest = c("CYEAR * URBAN", 
#                          # "T1_21_IND*CYEAR", # Liaoning Baseline
#                          # "T1_11_IND*CYEAR", 
#                          "T1_23_IND*CYEAR", 
#                         # "T1_31_IND*CYEAR", 
#                          "T1_32_IND*CYEAR",
#                          "T1_37_IND*CYEAR",
#                          "T1_41_IND*CYEAR",
#                          "T1_42_IND*CYEAR",
#                          "T1_43_IND*CYEAR",
#                          "T1_45_IND*CYEAR",
#                          "T1_52_IND*CYEAR",
#                         # "T1_55_IND*CYEAR",
#                           "CYEAR * BUSINESS_IND",
#                           "CYEAR * FARM_IND", 
#                           "CYEAR * FISH_IND",
#                          # "CYEAR * GARD_IND",
#                           "CYEAR * LVST_IND",
#                           "CYEAR * OTHR_IND", 
#                           "CYEAR * RETIRE_IND",
#                           "CYEAR * SUB_IND",
#                           "CYEAR^2","CYEAR^3")
# 
# remaining_variables_of_interest = variables_of_interest
# 
# current_variables = c("CYEAR",
#                       "URBAN",
#                       "T1",
#                       "BUSINESS_IND",
#                       "FARM_IND", 
#                       "FISH_IND",
#                       # "GARD_IND",
#                       "LVST_IND",
#                       "OTHR_IND", 
#                       "RETIRE_IND",
#                       "SUB_IND",
#                       "(1|HHID)")
# current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
# 
# while(TRUE){
#   print("current baseline")
#   print(current_variables)
#   # get baseline
#   current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
#   baseline = lmer(current_formula, data=df_trimmed, REML=FALSE)
#   
#   # loop through remaining variables of interest and create a new model
#   models = c()
#   for (var in remaining_variables_of_interest){
#     curr_var_loop = c(current_variables, var)
#     current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED~ ",paste(curr_var_loop, collapse="+"),sep = ""))
#     new_model = lmer(current_formula, data=df_trimmed, REML=FALSE)
#     models = c(models, new_model)
#   }
#   
#   # perform anova on baseline and a new model, record the resulting p-value
#   p_vals = c()
#   for (m in models){
#     anova_result = anova(baseline, m)
#     p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
#   }
#   
#   # if the smallest p-value is greater than 0.05, stop because no new variable is significant
#   if (min(p_vals)>0.05){
#     print("no remaining significant variables of interest")
#     break
#   }
#   print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
#   
#   # add most signficant variable to model
#   current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
#   
#   # remove the most significant variable from search space
#   remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
#   if (length(remaining_variables_of_interest)==0){
#     break
#   }
# }
```
## all 2 way interactions

The following code performs model selection on all two way interaction effects, compared to only interaction effects with cyear.
it has been commented out since it takes so long to run, but the results shown.

```{r}
# variables_of_interest = c("CYEAR * URBAN",
# "CYEAR * T1",
# "CYEAR * BUSINESS_IND",
# "CYEAR * FARM_IND",
# "CYEAR * FISH_IND",
# "CYEAR * LVST_IND",
# "CYEAR * OTHR_IND",
# "CYEAR * RETIRE_IND",
# "CYEAR * SUB_IND",
# "URBAN * T1",
# "URBAN * BUSINESS_IND",
# "URBAN * FARM_IND",
# "URBAN * FISH_IND",
# "URBAN * LVST_IND",
# "URBAN * OTHR_IND",
# "URBAN * RETIRE_IND",
# "URBAN * SUB_IND",
# "T1 * BUSINESS_IND",
# "T1 * FARM_IND",
# "T1 * FISH_IND",
# "T1 * LVST_IND",
# "T1 * OTHR_IND",
# "T1 * RETIRE_IND",
# "T1 * SUB_IND",
# "BUSINESS_IND * FARM_IND",
# "BUSINESS_IND * FISH_IND",
# "BUSINESS_IND * LVST_IND",
# "BUSINESS_IND * OTHR_IND",
# "BUSINESS_IND * RETIRE_IND",
# "BUSINESS_IND * SUB_IND",
# "FARM_IND * FISH_IND",
# "FARM_IND * LVST_IND",
# "FARM_IND * OTHR_IND",
# "FARM_IND * RETIRE_IND",
# "FARM_IND * SUB_IND",
# "FISH_IND * LVST_IND",
# "FISH_IND * OTHR_IND",
# "FISH_IND * RETIRE_IND",
# "FISH_IND * SUB_IND",
# "LVST_IND * OTHR_IND",
# "LVST_IND * RETIRE_IND",
# "LVST_IND * SUB_IND",
# "OTHR_IND * RETIRE_IND",
# "OTHR_IND * SUB_IND",
# "RETIRE_IND * SUB_IND")
# 
# remaining_variables_of_interest = variables_of_interest
# 
# current_variables = c("CYEAR",
#                       "URBAN",
#                       "T1",
#                       "BUSINESS_IND",
#                       "FARM_IND", 
#                       "FISH_IND",
#                       # "GARD_IND",
#                       "LVST_IND",
#                       "OTHR_IND", 
#                       "RETIRE_IND",
#                       "SUB_IND",
#                       "(1|HHID)")
# current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
# 
# while(TRUE){
#   print("current baseline")
#   print(current_variables)
#   # get baseline
#   current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
#   baseline = lmer(current_formula, data=df_trimmed, REML=FALSE)
#   
#   # loop through remaining variables of interest and create a new model
#   models = c()
#   for (var in remaining_variables_of_interest){
#     curr_var_loop = c(current_variables, var)
#     current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED~ ",paste(curr_var_loop, collapse="+"),sep = ""))
#     new_model = lmer(current_formula, data=df_trimmed, REML=FALSE)
#     models = c(models, new_model)
#   }
#   
#   # perform anova on baseline and a new model, record the resulting p-value
#   p_vals = c()
#   for (m in models){
#     anova_result = anova(baseline, m)
#     p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
#   }
#   
#   # if the smallest p-value is greater than 0.05, stop because no new variable is significant
#   if (min(p_vals)>0.05){
#     print("no remaining significant variables of interest")
#     break
#   }
#   print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
#   
#   # add most signficant variable to model
#   current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
#   
#   # remove the most significant variable from search space
#   remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
#   if (length(remaining_variables_of_interest)==0){
#     break
#   }
# }
```

```{r}
# all_two_way_interaction_model = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))

all_two_way_interaction_model_formula = as.formula("LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND + 
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 | 
    HHID) + CYEAR * T1 + CYEAR * RETIRE_IND + URBAN * T1 + T1 * 
    RETIRE_IND + CYEAR * BUSINESS_IND + BUSINESS_IND * RETIRE_IND + 
    T1 * FARM_IND + URBAN * OTHR_IND + OTHR_IND * RETIRE_IND + 
    CYEAR * SUB_IND + CYEAR * URBAN + LVST_IND * SUB_IND + RETIRE_IND * 
    SUB_IND + CYEAR * LVST_IND + T1 * OTHR_IND + T1 * LVST_IND + 
    FARM_IND * SUB_IND + T1 * BUSINESS_IND + OTHR_IND * SUB_IND + 
    FARM_IND * FISH_IND + BUSINESS_IND * FARM_IND + URBAN * BUSINESS_IND + 
    BUSINESS_IND * SUB_IND + T1 * SUB_IND + URBAN * FARM_IND + 
    CYEAR * OTHR_IND + FARM_IND * OTHR_IND + FISH_IND * OTHR_IND")
```


## 3 way interaction

The following code performs model selection on all three-way interaction effects involving cyear. It has been commented out since it takes so long to run, but the results are shown at the end.

```{r}

# variables_of_interest = c("CYEAR * URBAN * T1",
# "CYEAR * URBAN * BUSINESS_IND",
# "CYEAR * URBAN * FARM_IND",
# "CYEAR * URBAN * FISH_IND",
# "CYEAR * URBAN * LVST_IND",
# "CYEAR * URBAN * OTHR_IND",
# "CYEAR * URBAN * RETIRE_IND",
# "CYEAR * URBAN * SUB_IND",
# "CYEAR * T1 * BUSINESS_IND",
# "CYEAR * T1 * FARM_IND",
# "CYEAR * T1 * FISH_IND",
# "CYEAR * T1 * LVST_IND",
# "CYEAR * T1 * OTHR_IND",
# "CYEAR * T1 * RETIRE_IND",
# "CYEAR * T1 * SUB_IND",
# "CYEAR * BUSINESS_IND * FARM_IND",
# "CYEAR * BUSINESS_IND * FISH_IND",
# "CYEAR * BUSINESS_IND * LVST_IND",
# "CYEAR * BUSINESS_IND * OTHR_IND",
# "CYEAR * BUSINESS_IND * RETIRE_IND",
# "CYEAR * BUSINESS_IND * SUB_IND",
# "CYEAR * FARM_IND * FISH_IND",
# "CYEAR * FARM_IND * LVST_IND",
# "CYEAR * FARM_IND * OTHR_IND",
# "CYEAR * FARM_IND * RETIRE_IND",
# "CYEAR * FARM_IND * SUB_IND",
# "CYEAR * FISH_IND * LVST_IND",
# "CYEAR * FISH_IND * OTHR_IND",
# "CYEAR * FISH_IND * RETIRE_IND",
# "CYEAR * FISH_IND * SUB_IND",
# "CYEAR * LVST_IND * OTHR_IND",
# "CYEAR * LVST_IND * RETIRE_IND",
# "CYEAR * LVST_IND * SUB_IND",
# "CYEAR * OTHR_IND * RETIRE_IND",
# "CYEAR * OTHR_IND * SUB_IND",
# "CYEAR * RETIRE_IND * SUB_IND",
# "URBAN * T1 * BUSINESS_IND" #,
# )
# 
# remaining_variables_of_interest = variables_of_interest
# 
# current_variables = c("URBAN",
# "T1",
# "BUSINESS_IND",
# "FARM_IND",
# "FISH_IND",
# "LVST_IND",
# "OTHR_IND",
# "RETIRE_IND",
# "SUB_IND",
# "(1 | HHID)",
# "CYEAR * RETIRE_IND",
# "T1_23_IND * CYEAR",
# "T1_32_IND * CYEAR",
# "CYEAR * BUSINESS_IND",
# "T1_45_IND * CYEAR",
# "T1_41_IND * CYEAR",
# "T1_43_IND * CYEAR",
# "T1_37_IND * CYEAR",
# "CYEAR * URBAN",
# "CYEAR * SUB_IND",
# "T1_52_IND * CYEAR",
# "T1_42_IND * CYEAR",
# "CYEAR * LVST_IND",
# "CYEAR * OTHR_IND")
# current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
# 
# while(TRUE){
#   print("current baseline")
#   print(current_variables)
#   # get baseline
#   current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED ~ ",paste(current_variables, collapse="+"),sep = ""))
#   baseline = lmer(current_formula, data=df_trimmed, REML=FALSE)
# 
#   # loop through remaining variables of interest and create a new model
#   models = c()
#   for (var in remaining_variables_of_interest){
#     curr_var_loop = c(current_variables, var)
#     current_formula = as.formula(paste("LOG_THOUSANDS_SHIFTED~ ",paste(curr_var_loop, collapse="+"),sep = ""))
#     new_model = lmer(current_formula, data=df_trimmed, REML=FALSE)
#     models = c(models, new_model)
#   }
# 
#   # perform anova on baseline and a new model, record the resulting p-value
#   p_vals = c()
#   for (m in models){
#     anova_result = anova(baseline, m)
#     p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
#   }
# 
#   # if the smallest p-value is greater than 0.05, stop because no new variable is significant
#   if (min(p_vals)>0.05){
#     print("no remaining significant variables of interest")
#     break
#   }
#   print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
# 
#   # add most signficant variable to model
#   current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
# 
#   # remove the most significant variable from search space
#   remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
#   if (length(remaining_variables_of_interest)==0){
#     break
#   }
# }
```

```{r}
#three_way_model = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))
# three_way_model
three_way_model_formula = as.formula("LOG_THOUSANDS_SHIFTED ~ URBAN + T1 + BUSINESS_IND + FARM_IND + 
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 | 
    HHID) + CYEAR * RETIRE_IND + T1_23_IND * CYEAR + T1_32_IND * 
    CYEAR + CYEAR * BUSINESS_IND + T1_45_IND * CYEAR + T1_41_IND * 
    CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * URBAN + 
    CYEAR * SUB_IND + T1_52_IND * CYEAR + T1_42_IND * CYEAR + 
    CYEAR * LVST_IND + CYEAR * OTHR_IND + CYEAR * URBAN * T1 + 
    CYEAR * T1 * RETIRE_IND + CYEAR * BUSINESS_IND * RETIRE_IND + 
    CYEAR * T1 * FARM_IND + CYEAR * FARM_IND * SUB_IND + CYEAR * 
    RETIRE_IND * SUB_IND + CYEAR * T1 * LVST_IND + CYEAR * URBAN * 
    OTHR_IND + CYEAR * OTHR_IND * RETIRE_IND + CYEAR * LVST_IND * 
    SUB_IND + CYEAR * T1 * BUSINESS_IND + CYEAR * T1 * OTHR_IND + 
    CYEAR * T1 * SUB_IND + CYEAR * FARM_IND * OTHR_IND + CYEAR * 
    OTHR_IND * SUB_IND + CYEAR * BUSINESS_IND * SUB_IND + CYEAR * 
    BUSINESS_IND * FARM_IND + CYEAR * URBAN * BUSINESS_IND + 
    CYEAR * URBAN * FARM_IND + CYEAR * FARM_IND * FISH_IND + 
    CYEAR * BUSINESS_IND * OTHR_IND + URBAN * T1 * BUSINESS_IND + 
    CYEAR * T1 * FISH_IND + CYEAR * FISH_IND * OTHR_IND")
```


# cross validation

```{r}
HHIDs = unique(df_trimmed$HHID)

# 80 - 20 test split
test_size = 5 

our_MSEs = c()
two_way_MSEs = c()
three_way_MSEs = c()
four_way_MSEs = c()
set.seed(0)
for(i in 1:test_size){
  HHIDs = sample(HHIDs)
  # split into train and test folds
  test_indices = seq(i, length(HHIDs), test_size)
  train_fold_HHIDs = HHIDs[-test_indices]
  test_fold_HHIDs = HHIDs[test_indices]
  
  train_fold = df_trimmed[df_trimmed$HHID %in% train_fold_HHIDs,]
  test_fold = df_trimmed[df_trimmed$HHID %in% test_fold_HHIDs,]
  
  #create a new model on train_fold
  our_model = lmer(model_final_formula, REML = FALSE, data = train_fold)
  predictions = predict(our_model, test_fold, allow.new.levels=TRUE)
  residuals = exp(predictions) - exp(test_fold$LOG_THOUSANDS_SHIFTED)
  MSE = mean(residuals^2)
  our_MSEs = c(our_MSEs, MSE)
  
  two_way = lmer(all_two_way_interaction_model_formula, data=train_fold, REML=FALSE)
  predictions = predict(two_way, test_fold, allow.new.levels=TRUE)
  residuals = exp(predictions) - exp(test_fold$LOG_THOUSANDS_SHIFTED)
  MSE = mean(residuals^2)
  two_way_MSEs = c(two_way_MSEs, MSE)
  
  three_way = lmer(three_way_model_formula, data=train_fold, REML=FALSE)
  predictions = predict(three_way, test_fold, allow.new.levels=TRUE)
  residuals = exp(predictions) - exp(test_fold$LOG_THOUSANDS_SHIFTED)
  MSE = mean(residuals^2)
  three_way_MSEs = c(three_way_MSEs, MSE)  
}
```

```{r}
no_transform_MSEs = c()
sqrt_transform_MSEs = c()
sq_transform_MSEs = c()
set.seed(0)

for(i in 1:test_size){
  HHIDs = sample(HHIDs)
  # split into train and test folds
  test_indices = seq(i, length(HHIDs), test_size)
  train_fold_HHIDs = HHIDs[-test_indices]
  test_fold_HHIDs = HHIDs[test_indices]
  
  train_fold = df[df$HHID %in% train_fold_HHIDs,]
  test_fold = df[df$HHID %in% test_fold_HHIDs,]
  
  #no transformation on response variable
  SAmodel1 <- lmer(THOUSANDS ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND + FISH_IND +  
    LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 | HHID) +  
    CYEAR * RETIRE_IND + T1_23_IND * CYEAR + T1_32_IND * CYEAR +  
    CYEAR * BUSINESS_IND + T1_45_IND * CYEAR + T1_41_IND * CYEAR +  
    T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * URBAN + CYEAR *  
    SUB_IND + T1_52_IND * CYEAR + T1_42_IND * CYEAR + CYEAR *  
    LVST_IND + CYEAR * OTHR_IND, data=train_fold, REML=FALSE)
  
  predictions = predict(SAmodel1, test_fold, allow.new.levels=TRUE)
  residuals = (predictions) - (test_fold$THOUSANDS)
  MSE = mean(residuals^2)
  no_transform_MSEs = c(no_transform_MSEs, MSE)
  
  #square root transformation on response variable
  SAmodel2 <- lmer(sqrt(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + BUSINESS_IND +  
    FARM_IND + FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND +  
    SUB_IND + (1 | HHID) + CYEAR * RETIRE_IND + T1_23_IND * CYEAR +  
    T1_32_IND * CYEAR + CYEAR * BUSINESS_IND + T1_45_IND * CYEAR +  
    T1_41_IND * CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR +  
    CYEAR * URBAN + CYEAR * SUB_IND + T1_52_IND * CYEAR + T1_42_IND *  
    CYEAR + CYEAR * LVST_IND + CYEAR * OTHR_IND, data=train_fold, REML=FALSE)
  
  predictions = predict(SAmodel2, test_fold, allow.new.levels=TRUE)
  residuals = (predictions^2) - (test_fold$THOUSANDS_SHIFTED)
  MSE = mean(residuals^2)
  sqrt_transform_MSEs = c(sqrt_transform_MSEs, MSE)
  
  #squared transformation on response variable
  SAmodel3 <- lmer((THOUSANDS_SHIFTED)^2 ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND +  
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 |  
    HHID) + CYEAR * RETIRE_IND + T1_23_IND * CYEAR + T1_32_IND *  
    CYEAR + CYEAR * BUSINESS_IND + T1_45_IND * CYEAR + T1_41_IND *  
    CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * URBAN +  
    CYEAR * SUB_IND + T1_52_IND * CYEAR + T1_42_IND * CYEAR +  
    CYEAR * LVST_IND + CYEAR * OTHR_IND, data=train_fold, REML=FALSE)
  
  predictions = predict(SAmodel3, test_fold, allow.new.levels=TRUE)
  residuals = (sqrt(predictions)) - (test_fold$THOUSANDS)
  MSE = mean(residuals^2)
  sq_transform_MSEs = c(sq_transform_MSEs, MSE)
  
}
```

```{r}
mean(our_MSEs)
sd(our_MSEs)

mean(two_way_MSEs)
sd(two_way_MSEs)

mean(three_way_MSEs)
sd(three_way_MSEs)

mean(four_way_MSEs)
sd(four_way_MSEs)

mean(no_transform_MSEs)
sd(no_transform_MSEs)

mean(sqrt_transform_MSEs)
sd(sqrt_transform_MSEs)

mean(sq_transform_MSEs)
sd(sq_transform_MSEs)

```

# Interpretation of beta coefficients

```{r}
#full model with all variables in final model
test_full <- lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND +  
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 |  
    HHID) + CYEAR * RETIRE_IND + T1_23_IND * CYEAR + T1_32_IND *  
    CYEAR + CYEAR * BUSINESS_IND + T1_45_IND * CYEAR + T1_41_IND *  
    CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * URBAN +  
    CYEAR * SUB_IND + T1_52_IND * CYEAR + T1_42_IND * CYEAR +  
    CYEAR * LVST_IND + CYEAR * OTHR_IND, data=df_trimmed, REML=FALSE)

#model without province interaction terms
provtest_reduced <- lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND +  
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1|HHID) + CYEAR * RETIRE_IND + CYEAR * BUSINESS_IND + CYEAR *  
    URBAN + CYEAR * SUB_IND + CYEAR * LVST_IND + CYEAR * OTHR_IND, data=df_trimmed, REML=FALSE)

#model without urban interaction terms
urbtest_reduced <- lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND +  
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 |  
    HHID) + CYEAR * RETIRE_IND + T1_23_IND * CYEAR + T1_32_IND * CYEAR + CYEAR * BUSINESS_IND + T1_45_IND * CYEAR + 
      T1_41_IND * CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * SUB_IND + T1_52_IND * CYEAR + T1_42_IND * CYEAR +  
      CYEAR * LVST_IND + CYEAR * OTHR_IND, data=df_trimmed, REML=FALSE)

#model without income source interaction terms
incsource_reduced <- lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND +  
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1|HHID) + T1_23_IND * CYEAR + T1_32_IND * CYEAR + 
    T1_45_IND * CYEAR + T1_41_IND * CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * URBAN +  
    T1_52_IND * CYEAR + T1_42_IND * CYEAR, data=df_trimmed, REML=FALSE)

#model without cyear interaction terms
year_reduced <- lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND +  
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 |  
    HHID), data=df_trimmed, REML=FALSE)

prov_test <- anova(test_full, provtest_reduced)
urb_test <- anova(test_full, urbtest_reduced)
incsource_test <- anova(test_full, incsource_reduced)
year_test <- anova(test_full, year_reduced)
test_results <- rbind(prov_test, urb_test, incsource_test, year_test)
test_results_table <- kable(test_results, caption="Likelihood Ratio Test", align="c")
test_results_table
```

#Changes in household income by income source
```{r}
for (i in yrs) {
  bus <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["BUSINESS_IND1",]+yrs*estimate["CYEAR:BUSINESS_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  d <- data.frame(bus)
}

for (i in yrs) {
  farm <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["FARM_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df0 <- data.frame(farm)
}

for (i in yrs) {
  fish <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["FISH_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df1 <- data.frame(fish)
}

for (i in yrs) {
  gard <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df2 <- data.frame(gard)
}

for (i in yrs) {
  lvst <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["LVST_IND1",]+yrs*estimate["CYEAR:LVST_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df3 <- data.frame(lvst)
}

for (i in yrs) {
  othr <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["OTHR_IND1",]+yrs*estimate["CYEAR:OTHR_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df4 <- data.frame(othr)
}

for (i in yrs) {
  retire <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["RETIRE_IND1",]+yrs*estimate["CYEAR:RETIRE_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df5 <- data.frame(retire)
}

for (i in yrs) {
  sub <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["SUB_IND1",]+yrs*estimate["CYEAR:SUB_IND1",])-(abs(min(df_trimmed$THOUSANDS))+0.01)
  df6 <- data.frame(sub)
}

source.data <- cbind(xvar, d, df0, df1, df2, df3, df4, df5, df6)
source.data$xvar <- as.numeric(as.character(source.data$xvar))
mdf1 <- melt(source.data, id.vars="xvar")

plot1 <- ggplot(mdf1, aes(x=xvar, y=value, group=variable, color=variable)) + 
  geom_line(aes(color=variable)) +
  geom_point() +
  scale_color_discrete(name="Income \nSource",
                       labels=c("Business","Farming", "Fishing", "Gardening", "Livestock", "Others", "Retirement", "Subsidies")) +
  labs(title="4a: Changes in Household Income per Capita \nOver Time by Income Source",
       x="Year",
       y="Expected Income (thousands)") +
    theme(plot.title = element_text(size=20),
          legend.position = "bottom",
          text = element_text(size=15))
```

#Changes in household income by province
```{r}
yrs <- c(0,2,4,8,11,15,17,20,22,26)
xvar <- c("1989", "1991", "1993", "1997", "2000", "2004", "2006", "2009", "2011", "2015")
estimate <- as.data.frame(summary(model_final)$coefficients)
estimate <- estimate %>% dplyr::select(Estimate)

for (i in yrs) {
  prov21 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T121",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df7 <- data.frame(prov21)
}
for (i in yrs) {
  prov23 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T123",]+yrs*estimate["CYEAR:T1_23_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df8 <- data.frame(prov23)
}
for (i in yrs) {
  prov32 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T132",]+yrs*estimate["CYEAR:T1_32_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df10 <- data.frame(prov32)
}
for (i in yrs) {
  prov37 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T137",]+yrs*estimate["CYEAR:T1_37_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df11 <- data.frame(prov37)
}
for (i in yrs) {
  prov41 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T141",]+yrs*estimate["CYEAR:T1_41_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df12 <- data.frame(prov41)
}
for (i in yrs) {
  prov42 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T142",]+yrs*estimate["CYEAR:T1_42_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df13 <- data.frame(prov42)
}
for (i in yrs) {
  prov43 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T143",]+yrs*estimate["CYEAR:T1_43_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df14 <- data.frame(prov43)
}
for (i in yrs) {
  prov45 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T145",]+yrs*estimate["CYEAR:T1_45_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df15 <- data.frame(prov45)
}
for (i in yrs) {
  prov52 <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T152",]+yrs*estimate["CYEAR:T1_52_IND1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df16 <- data.frame(prov52)
}

prov.data <- cbind(xvar, df7, df8, df10, df11, df12, df13, df14, df15, df16)
prov.data$xvar <- as.numeric(as.character(prov.data$xvar))
mdf2 <- melt(prov.data, id.vars="xvar")

plot2 <- ggplot(mdf2, aes(x=xvar, y=value, group=variable, color=variable)) + 
  geom_line() +
  geom_point() +
  scale_color_discrete(name="Province",
                       labels=c("Liaoning", "Heilongjiang", "Jiangsu", "Shandong", "Henan", "Hubei", "Hunan", "Guangxi", "Guizhou")) +
  labs(title= "4b: Changes in Household Income per Capita \nOver Time by Province",
       x="Year",
       y="Expected Income (thousands)") +
    theme(plot.title = element_text(size=20),
          legend.position = "bottom",
          text = element_text(size=15))
plot2
```

#Changes in household income by urban/rural status
```{r}
for (i in yrs) {
  urb <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["URBAN1",]+estimate["CYEAR:URBAN1",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df19 <- data.frame(urb)
}
for (i in yrs) {
  rur <- exp(estimate["(Intercept)",]+yrs*estimate["CYEAR",]) - (abs(min(df_trimmed$THOUSANDS))+0.01)
  df20 <- data.frame(rur)
}

urb.data <- cbind(xvar, df19, df20)
urb.data$xvar <- as.numeric(as.character(urb.data$xvar))
mdf3 <- melt(urb.data, id.vars="xvar")

plot3 <- ggplot(mdf3, aes(x=xvar, y=value, group=variable, color=variable)) +
  geom_line() +
  geom_point() +
  scale_color_discrete(name="Status",
                       labels=c("Urban", "Rural")) +
  labs(title="4c: Changes in Household Income per Capita \nOver Time by Urban/Rural Status",
       x="Year",
       y="Expected Income (thousands)") +
  theme(plot.title = element_text(size=20),
        legend.position = "bottom",
        text = element_text(size=15))

```

# Income Inequality

```{r ineq1}
library(ineq)
library(tidyverse)
#gini index overtime
gini.years = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE) %>%
  dplyr::arrange(HHINCPC_CPI) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  dplyr::group_by(WAVE) %>%
  dplyr::summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

p1 = ggplot(gini.years,aes(x = factor(WAVE),y = index)) +
  geom_line() +
  geom_point()+
  geom_text(aes(label = round(index, 2)),hjust = -0.2,vjust = 0.5) +
  ggtitle("Gini Index Over Year in China") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

years = c(1989,1991,1993,1997,2000,2004,2006,2009,2011,2015)
cols <- c("#ffe6e6","#ffcccc","#ff8080","#ff8080","#ff1a1a","#ff1a1a","#b30000","#660000","#330000")
plot(Lc(df[df$WAVE ==1989,]$HHINCPC_CPI),lwd=2,col = "#ffe6e6")
for (i in 2:length(years)){
  lines(Lc(df[df$WAVE==years[i],]$HHINCPC_CPI),col=cols[i],lwd=2)
}

#png("gini_year.png")
#print(p1)
#dev.off()
```

```{r ineq2}
#gini index overtime and provinces
df =  df %>%
  mutate(city = case_when(T1 == 11 ~ "Beijing",
                          T1 == 21  ~ "LiaoNing",
                          T1 == 23  ~ "Heilongjiang",
                          T1 == 31  ~ "Shanghai",
                          T1 == 32  ~ "Jiangsu",
                          T1 == 33  ~ "Zhejiang",
                          T1 == 37  ~ "Shandong",
                          T1 == 41  ~ "Henan",
                          T1 == 42  ~ "Hubei",
                          T1 == 43  ~ "Hunan",
                          T1 == 45  ~ "Guangxi",
                          T1 == 52  ~ "Guizhou",
                          T1 == 53  ~ "Yunnan",
                          T1 == 55  ~ "Chongqing",
                          T1 == 61  ~ "Shanxi"))
gini.years$city = c("China","China","China","China","China","China","China","China","China","China")
gini.years.province = df %>%
  dplyr::select(HHID,HHINCPC_CPI,T1,WAVE,city) %>%
  #arrange(HHINCPC_CPI) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  dplyr::group_by(city,WAVE) %>%
  dplyr::summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

p2 = ggplot(gini.years.province,aes(x = factor(WAVE),y = index,group = city,color = city)) +
  geom_line() +
  geom_point()+
  geom_line(data = gini.years,aes(x = factor(WAVE),y = index),color = "black") + 
  ggtitle("5c: Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

#png("gini_year_province.png")
#print(p2)
#dev.off()
```

```{r ineq3}
df =  df %>%
  mutate(primary_income = case_when(PRIMARY == "HHBUS"~ HHBUS,
                          PRIMARY == "HHFARM"~ HHFARM,
                          PRIMARY == "HHFISH"~ HHFISH,
                          PRIMARY == "HHGARD"~ HHGARD,
                          PRIMARY == "HHLVST"~ HHLVST,
                          PRIMARY == "HHNRWAGE"~ HHNRWAGE,
                          PRIMARY == "HHOTHR"~ HHOTHR,
                          PRIMARY == "HHRETIRE"~ HHRETIRE,
                          PRIMARY == "HHSUB"~ HHSUB))
gini.years.primary = df %>%
  dplyr::select(HHID,primary_income,T1,WAVE,city,PRIMARY) %>%
  transform(primary_income = ifelse(primary_income < 0, 0, primary_income)) %>%
  dplyr::group_by(PRIMARY,WAVE) %>%
  dplyr::summarise(index = ineq(primary_income,type = c("Gini")))

ggplot(gini.years.primary,aes(x = WAVE,y = index,group = PRIMARY,color = PRIMARY)) +
  geom_line()+
  #geom_point()+
  ggtitle("5a: Gini Index Over Year by Primary Outcome") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(gini.years.primary,aes(x = WAVE,y = index)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~PRIMARY)
```

```{r ineq4}
gini.years.urban = df %>%
  dplyr::select(HHID,primary_income,T1,WAVE,URBAN) %>%
  transform(primary_income = ifelse(primary_income < 0, 0, primary_income)) %>%
  dplyr::group_by(URBAN,WAVE) %>%
  dplyr::summarise(index = ineq(primary_income,type = c("Gini")))

ggplot(gini.years.urban,aes(x = WAVE,y = index,group = URBAN,color = URBAN)) +
  geom_line()+
  #geom_point()+
  ggtitle("5b: Gini Index Over Year by Urban/Rural") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r ratio1}
ratio.years = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE,city) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(top10)/sum(bottom10),sumb = sum(top10),sumt =sum(bottom10))

ggplot(ratio.years,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  geom_text(aes(label = round(ratio, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r ratio2}
ratio.years.province = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE,city) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE,city) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(top10)/sum(bottom10),sumb = sum(top10),sumt =sum(bottom10))

ggplot(ratio.years.province,aes(x = WAVE,y = ratio,group = city,color = city)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(ratio.years.province,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~city)
```

```{r ratio3}
ratio.years.primary = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE,PRIMARY) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE,PRIMARY) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(top10)/sum(bottom10),sumb = sum(top10),sumt =sum(bottom10))

ggplot(ratio.years.primary,aes(x = WAVE,y = ratio,group = PRIMARY,color = PRIMARY)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(ratio.years.primary,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~PRIMARY)
```

# Model with Outliers
```{r outliers}
model_outliers = lmer(LOG_THOUSANDS_SHIFTED ~ CYEAR + URBAN + T1 + BUSINESS_IND + FARM_IND + 
    FISH_IND + LVST_IND + OTHR_IND + RETIRE_IND + SUB_IND + (1 | 
    HHID) + CYEAR * RETIRE_IND + T1_23_IND * CYEAR + T1_32_IND * 
    CYEAR + CYEAR * BUSINESS_IND + T1_45_IND * CYEAR + T1_41_IND * 
    CYEAR + T1_43_IND * CYEAR + T1_37_IND * CYEAR + CYEAR * URBAN + 
    CYEAR * SUB_IND + T1_52_IND * CYEAR + T1_42_IND * CYEAR + 
    CYEAR * LVST_IND + CYEAR * OTHR_IND, data=df)
```

```{r}
final.coef = coef(summary(model_final))[ , "Estimate"]
exp.final.coef = exp(coef(summary(model_final))[ , "Estimate"])
outliers.coef = coef(summary(model_outliers))[ , "Estimate"]
exp.outlier.coef = exp(coef(summary(model_outliers))[ , "Estimate"])

CI_interval.final = confint(model_final)
exp_CI_interval.final = exp(CI_interval.final)
test.final = exp_CI_interval.final[-3,]

CI_interval = confint(model_outliers)
exp_CI_interval = exp(CI_interval)
test.outliers = exp_CI_interval[-3,]
```

```{r}
comparison <- cbind(coef_final = final.coef, coef_outlers = outliers.coef,exp_final_coef = exp.final.coef,exp_outlier_coec = exp.outlier.coef)
knitr::kable(comparison , digits = 4,format = "latex")
```

