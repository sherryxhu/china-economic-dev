---
title: "Final_China_Code"
author: "Daniel Zhou, Sherry Hu, Peining Yang, Siyi Xu"
date: "6/3/2020"
output: html_document
---

```{r}
# libraries that need to be installed and loaded
library(tidyverse)
library(mice)
library(reshape2)
library(ggplot2)
library(lme4)
library(lattice)
library(caret)
library(monomvn)
library(ineq)
library(car)
library(knitr)
library(reshape)

```

# Data Preparation

```{r}

# read in data
require(haven)
sashhinc=read_sas("hhinc_10.sas7bdat")

# let's make this more interpretable by letting 1989 be year 0
# also let's convert income to thousands of yuan
sashhinc$cyear=sashhinc$WAVE-1989
sashhinc$thousands=sashhinc$hhincpc_cpi/1000

# replace NAs w/ null
sashhinc[is.na(sashhinc)] = 0
sashhinc_trimmed = sashhinc
# shift variables to positive in the case we want to use a log transform 
sashhinc$thousands_shifted=sashhinc$thousands - (min(sashhinc$thousands)-0.01)

# change to categorical variables
sashhinc$urban <- as.factor(sashhinc$urban)
sashhinc$hhid <- as.factor(sashhinc$hhid)
sashhinc$t1 <- as.factor(sashhinc$t1)

## .1% removed- put in sashhinc_trimmed df
lower = quantile(sashhinc$thousands, 0.001)
upper = quantile(sashhinc$thousands, 0.999)
sashhinc_trimmed = subset(sashhinc, lower < thousands & thousands < upper)
sashhinc_trimmed$thousands_shifted=sashhinc_trimmed$thousands - (min(sashhinc_trimmed$thousands)-0.01)

```

```{r}
# take a peek at dataset
colnames(sashhinc)
summary(sashhinc)
```

```{r data_cleaning}
# select variables we need for df
df = dplyr::select(sashhinc,
            hhid,
            WAVE,
            hhinc_cpi, 
            hhincpc_cpi, 
            HHBUS, 
            HHBUSimp, 
            HHFARM, 
            HHFARMimp, 
            HHFISH, 
            HHFISHimp, 
            hhgard, 
            HHGARDimp,
            HHLVST,
            HHLVSTimp,
            hhNRwage,
            HHNRWAGEimp,
            HHOTHR,
            HHOTHRimp,
            HHRETIRE,
            HHRETIREimp,
            HHSUB,
            HHSUBimp,
            t1,
            urban,
            thousands,
            cyear,
            thousands_shifted)

names(df)<- toupper(names(df))

#add primary income source variable
df <- df %>% 
        mutate(Primary = colnames(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")])[apply(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")], 1, which.max)])


# select variables we need for df w/o outliers
df_trimmed = dplyr::select(sashhinc_trimmed,
            hhid,
            WAVE,
            hhinc_cpi, 
            hhincpc_cpi, 
            HHBUS, 
            HHBUSimp, 
            HHFARM, 
            HHFARMimp, 
            HHFISH, 
            HHFISHimp, 
            hhgard, 
            HHGARDimp,
            HHLVST,
            HHLVSTimp,
            hhNRwage,
            HHNRWAGEimp,
            HHOTHR,
            HHOTHRimp,
            HHRETIRE,
            HHRETIREimp,
            HHSUB,
            HHSUBimp,
            t1,
            urban,
            thousands,
            cyear,
            thousands_shifted)

#add primary income source variable
df_trimmed <- df_trimmed %>% 
        mutate(Primary = colnames(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")])[apply(df_trimmed[, c("HHBUS", "HHFARM", "HHFISH", "hhgard", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")], 1, which.max)])

#add variable indicating whether household receives income from specific sources
df <- df %>% 
  mutate(business_ind = factor(as.numeric(HHBUS != 0)),
         farm_ind = factor(as.numeric(HHFARM != 0)),
         fish_ind = factor(as.numeric(HHFISH != 0)),
         gard_ind = factor(as.numeric(HHGARD != 0)),
         lvst_ind = factor(as.numeric(HHLVST != 0)),
         othr_ind = factor(as.numeric(HHOTHR != 0)),
         retire_ind = factor(as.numeric(HHRETIRE != 0)),
         sub_ind = factor(as.numeric(HHSUB != 0)))

names(df)<- toupper(names(df))
df$T1 = as.factor(df$T1)

names(df_trimmed)<- toupper(names(df_trimmed))
df_trimmed$T1 = as.factor(df_trimmed$T1)

head(df)
head(df_trimmed)

```

# Preliminary Checks

```{r}
# fit model with all interactions
m1 = lmer(THOUSANDS ~ CYEAR + URBAN + T1 + PRIMARY + 
          CYEAR*URBAN + PRIMARY*CYEAR + URBAN*PRIMARY
          + CYEAR*T1 + URBAN*T1 + T1*PRIMARY
        + (1 | HHID), data=df)
summary(m1)
anova(m1)
```

```{r}
qqmath(resid(m1))
plot(m1,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Initial Model Residuals")
```

```{r}
# fit model w/ log transform w/ outliers 
m2 = lmer(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + PRIMARY + 
          CYEAR*URBAN + PRIMARY*CYEAR + URBAN*PRIMARY
          + CYEAR*T1 + URBAN*T1 + T1*PRIMARY
        + (1 | HHID), data=df)

summary(m2)
```

```{r}
qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Logged Model Residuals")
```

```{r}
# fit model w/ log transform w/o outliers 
m3 = lmer(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + PRIMARY + 
          CYEAR*URBAN + PRIMARY*CYEAR + URBAN*PRIMARY
          + CYEAR*T1 + URBAN*T1 + T1*PRIMARY
        + (1 | HHID), data=df_trimmed)

summary(m3)
```

```{r}
qqmath(resid(m3))
plot(m3,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Residuals of log model without outliers")
```

# Initial Model 
```{r}
colnames(df)
``` 

```{r}
# fit model with all interactions
m1 = lmer(THOUSANDS ~ CYEAR + URBAN + T1 + PRIMARY + 
          CYEAR*URBAN + PRIMARY*CYEAR + URBAN*PRIMARY
          + CYEAR*T1 + URBAN*T1 + T1*PRIMARY
        + (1 | HHID), data=df)
summary(m1)
anova(m1)
```

```{r}
qqmath(resid(m1))
plot(m1,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Initial Model Residuals")
```

We note that the residual plot looks bad and has a fanned shape from left to right. We try a log transform of the response variable. Note that log cannot take on negative values, so we shift all values in the dataset by the minimum value in the dataset and add 0.01. This is the denoted as the variable THOUSANDS_SHIFTED, which we computed above. 

```{r}
# fit model w/ log transform w/ outliers 
m2 = lmer(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + PRIMARY + 
          CYEAR*URBAN + PRIMARY*CYEAR + URBAN*PRIMARY
          + CYEAR*T1 + URBAN*T1 + T1*PRIMARY
        + (1 | HHID), data=df)

summary(m2)
```

```{r}
qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Logged Model Residuals")
```

It looks like the log transform improved the residual plots a bit. However, is this because the plot is zoomed out so much, or is it actually making a difference? Let's remove the outliers, which are causing the zoom out, and reevaluate the effect of the log transform. 

```{r}
# fit model w/ log transform w/o outliers 
m3 = lmer(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + PRIMARY + 
          CYEAR*URBAN + PRIMARY*CYEAR + URBAN*PRIMARY
          + CYEAR*T1 + URBAN*T1 + T1*PRIMARY
        + (1 | HHID), data=df_trimmed)

summary(m3)
```

```{r}
qqmath(resid(m3))
plot(m3,resid(.,scaled=TRUE)~fitted(.),abline=0, xlab = "Fitted Values", ylab = "Residuals", main="Residuals of log model without outliers")
```

We see that indeed, the log transformation did not do much to help the residuals plot. We proceed without a log transform for sake of simplicity and for interpretability reasons. 

# Model Selection

## primary is significant
```{r}
# no PRIMARY
m1 = lmer(THOUSANDS ~ CYEAR + URBAN + T1 + (1 |HHID), data=df, REML=FALSE)

# PRIMARY
m2 = lmer(THOUSANDS ~ CYEAR + URBAN + T1 + PRIMARY +(1 |HHID), data=df, REML=FALSE)

anova(m1, m2)
```

## 2 way interactions
```{r}
variables_of_interest = c("CYEAR * URBAN", 
                          "CYEAR * T1", 
                          "CYEAR * PRIMARY", 
                          "URBAN * T1", 
                          "URBAN * PRIMARY", 
                          "T1 * PRIMARY")

remaining_variables_of_interest = variables_of_interest

current_variables = c("CYEAR",
                      "URBAN",
                      "T1",
                      "PRIMARY",
                      "(1|HHID)")
current_formula = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))

while(TRUE){
  print("current baseline")
  print(current_variables)
  # get baseline
  current_formula = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))
  baseline = lmer(current_formula, data=df, REML=FALSE)
  
  # loop through remaining variables of interest and create a new model
  models = c()
  for (var in remaining_variables_of_interest){
    curr_var_loop = c(current_variables, var)
    current_formula = as.formula(paste("THOUSANDS~ ",paste(curr_var_loop, collapse="+"),sep = ""))
    new_model = lmer(current_formula, data=df, REML=FALSE)
    models = c(models, new_model)
  }
  
  # perform anova on baseline and a new model, record the resulting p-value
  p_vals = c()
  for (m in models){
    anova_result = anova(baseline, m)
    p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
  }
  
  # if the smallest p-value is greater than 0.05, stop because no new variable is significant
  if (min(p_vals)>0.05){
    print("no remaining significant variables of interest")
    break
  }
  print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
  
  # add most signficant variable to model
  current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
  
  # remove the most significant variable from search space
  remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
  if (length(remaining_variables_of_interest)==0){
    break
  }
}
```

```{r}
two_way_model = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))
two_way_model
```


## 3 way interaction

```{r} 

# CYEAR, URBAN, T1, PRIMARY
variables_of_interest = c("CYEAR * URBAN * T1", 
                          "CYEAR * URBAN * PRIMARY",
                          "CYEAR * T1 * PRIMARY", 
                          "URBAN * CYEAR * PRIMARY")

remaining_variables_of_interest = variables_of_interest

current_formula = two_way_model

while(TRUE){
  print("current baseline")
  print(current_variables)
  # get baseline
  current_formula = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))
  baseline = lmer(current_formula, data=df, REML=FALSE)
  
  # loop through remaining variables of interest and create a new model
  models = c()
  for (var in remaining_variables_of_interest){
    curr_var_loop = c(current_variables, var)
    current_formula = as.formula(paste("THOUSANDS ~ ",paste(curr_var_loop, collapse="+"),sep = ""))
    new_model = lmer(current_formula, data=df, REML=FALSE)
    models = c(models, new_model)
  }
  
  p_vals = c()
  for (m in models){
    anova_result = anova(baseline, m)
    p_vals= c(p_vals, anova_result$`Pr(>Chisq)`[2])
  }
  
  if (min(p_vals)>0.05){
    print("no remaining significant variables of interest")
    break
  }
  print(paste("selected", remaining_variables_of_interest[which.min(p_vals)], ", p-value of", min(p_vals) ))
  
  # add most signficant variable to model
  current_variables = c(current_variables, remaining_variables_of_interest[which.min(p_vals)])
  
  # remove the most significant variable from search space
  remaining_variables_of_interest = remaining_variables_of_interest[-which.min(p_vals)]
  if (length(remaining_variables_of_interest)==0){
    break
  }
}
```

```{r}
three_way_model = as.formula(paste("THOUSANDS ~ ",paste(current_variables, collapse="+"),sep = ""))
three_way_model
```

## four way model
```{r}

m1 = lmer(THOUSANDS ~ URBAN +  CYEAR +  T1 + PRIMARY + CYEAR*URBAN + CYEAR*PRIMARY 
           + CYEAR*T1 + URBAN*T1 + CYEAR * T1 * PRIMARY + CYEAR * URBAN * T1 
          + (1|HHID), REML = FALSE, data = df)

m2 = lmer(THOUSANDS ~ URBAN +  CYEAR +  T1 + PRIMARY + CYEAR*URBAN + CYEAR*PRIMARY 
           + CYEAR*T1 + URBAN*T1 + CYEAR * T1 * PRIMARY + CYEAR * URBAN * T1 
          + CYEAR * URBAN * T1 * PRIMARY
          + (1|HHID), REML = FALSE, data = df)
anova(m1, m2)
```

```{r}
four_way_model = as.formula("THOUSANDS ~ URBAN +  CYEAR +  T1 + PRIMARY + CYEAR*URBAN + CYEAR*PRIMARY + CYEAR*T1 + URBAN*T1 + CYEAR * T1 * PRIMARY + CYEAR * URBAN * T1 + CYEAR * URBAN * T1 * PRIMARY + (1|HHID)")
four_way_model
```


# final model
```{r}
final_model = lmer(THOUSANDS ~ URBAN +  CYEAR +  T1 + PRIMARY + CYEAR*URBAN + CYEAR*PRIMARY 
           + CYEAR*T1 + URBAN*T1 
          + (1|HHID), REML = FALSE, data = df)
summary(final_model)
```

# model diagnostics

```{r}
qqmath(resid(final_model))
plot(final_model,resid(.,scaled=TRUE)~fitted(.),abline=0, main="Final Model Residuals")
```

```{r}
vif(final_model)
```


# cross validation

```{r}
HHIDs = unique(df$HHID)

# do random sampling
n_times = 10

# 80 - 20 test split
test_size = 5 

our_MSEs = c()
two_way_MSEs = c()
three_way_MSEs = c()
four_way_MSEs = c()
set.seed(0)
for(i in 1:test_size){
  HHIDs = sample(HHIDs)
  # split into train and test folds
  test_indices = seq(i, length(HHIDs), test_size)
  train_fold_HHIDs = HHIDs[-test_indices]
  test_fold_HHIDs = HHIDs[test_indices]
  
  train_fold = df[df$HHID %in% train_fold_HHIDs,]
  test_fold = df[df$HHID %in% test_fold_HHIDs,]
  
  #create a new model on train_fold
  our_model = lmer(THOUSANDS ~ URBAN +  CYEAR +  T1 + PRIMARY + CYEAR*URBAN + CYEAR*PRIMARY 
           + CYEAR*T1 + URBAN*T1 
          + (1|HHID), REML = FALSE, data = train_fold)
  predictions = predict(our_model, test_fold, allow.new.levels=TRUE)
  residuals = (predictions) - (test_fold$THOUSANDS)
  MSE = mean(residuals^2)
  our_MSEs = c(our_MSEs, MSE)
  
  two_way = lmer(two_way_model, data=train_fold, REML=FALSE)
  predictions = predict(two_way, test_fold, allow.new.levels=TRUE)
  residuals = (predictions) - (test_fold$THOUSANDS)
  MSE = mean(residuals^2)
  two_way_MSEs = c(two_way_MSEs, MSE)
  
  three_way = lmer(three_way_model, data=train_fold, REML=FALSE)
  predictions = predict(three_way, test_fold, allow.new.levels=TRUE)
  residuals = (predictions) - (test_fold$THOUSANDS)
  MSE = mean(residuals^2)
  three_way_MSEs = c(three_way_MSEs, MSE)  
  
  four_way = lmer(four_way_model, data=train_fold, REML=FALSE)
  predictions = predict(four_way, test_fold, allow.new.levels=TRUE)
  residuals = (predictions) - (test_fold$THOUSANDS)
  MSE = mean(residuals^2)
  four_way_MSEs = c(four_way_MSEs, MSE)
}
```

```{r}
mean(our_MSEs)
sd(our_MSEs)

mean(two_way_MSEs)
sd(two_way_MSEs)

mean(three_way_MSEs)
sd(three_way_MSEs)

mean(four_way_MSEs)
sd(four_way_MSEs)

```

# Income Inequality

```{r ineq1}
library(ineq)
library(tidyverse)
#gini index overtime
gini.years = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE) %>%
  arrange(HHINCPC_CPI) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE) %>%
  summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

p1 = ggplot(gini.years,aes(x = factor(WAVE),y = index)) +
  geom_line() +
  geom_point()+
  geom_text(aes(label = round(index, 2)),hjust = -0.2,vjust = 0.5) +
  ggtitle("Gini Index Over Year in China") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

years = c(1989,1991,1993,1997,2000,2004,2006,2009,2011,2015)
cols <- c("#ffe6e6","#ffcccc","#ff8080","#ff8080","#ff1a1a","#ff1a1a","#b30000","#660000","#330000")
plot(Lc(df[df$WAVE ==1989,]$HHINCPC_CPI),lwd=2,col = "#ffe6e6")
for (i in 2:length(years)){
  lines(Lc(df[df$WAVE==years[i],]$HHINCPC_CPI),col=cols[i],lwd=2)
}

#png("gini_year.png")
#print(p1)
#dev.off()
```

```{r ineq2}
#gini index overtime and provinces
df =  df %>%
  mutate(city = case_when(T1 == 11 ~ "Beijing",
                          T1 == 21  ~ "LiaoNing",
                          T1 == 23  ~ "Heilongjiang",
                          T1 == 31  ~ "Shanghai",
                          T1 == 32  ~ "Jiangsu",
                          T1 == 33  ~ "Zhejiang",
                          T1 == 37  ~ "Shandong",
                          T1 == 41  ~ "Henan",
                          T1 == 42  ~ "Hubei",
                          T1 == 43  ~ "Hunan",
                          T1 == 45  ~ "Guangxi",
                          T1 == 52  ~ "Guizhou",
                          T1 == 53  ~ "Yunnan",
                          T1 == 55  ~ "Chongqing",
                          T1 == 61  ~ "Shanxi"))
gini.years$city = c("China","China","China","China","China","China","China","China","China","China")
gini.years.province = df %>%
  dplyr::select(HHID,HHINCPC_CPI,T1,WAVE,city) %>%
  #arrange(HHINCPC_CPI) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(city,WAVE) %>%
  summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

p2 = ggplot(gini.years.province,aes(x = factor(WAVE),y = index,group = city,color = city)) +
  geom_line() +
  geom_point()+
  geom_line(data = gini.years,aes(x = factor(WAVE),y = index),color = "black") + 
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

#png("gini_year_province.png")
#print(p2)
#dev.off()
```

```{r ineq3}
df =  df %>%
  mutate(primary_income = case_when(PRIMARY == "HHBUS"~ HHBUS,
                          PRIMARY == "HHFARM"~ HHFARM,
                          PRIMARY == "HHFISH"~ HHFISH,
                          PRIMARY == "HHGARD"~ HHGARD,
                          PRIMARY == "HHLVST"~ HHLVST,
                          PRIMARY == "HHNRWAGE"~ HHNRWAGE,
                          PRIMARY == "HHOTHR"~ HHOTHR,
                          PRIMARY == "HHRETIRE"~ HHRETIRE,
                          PRIMARY == "HHSUB"~ HHSUB))
gini.years.primary = df %>%
  dplyr::select(HHID,primary_income,T1,WAVE,city,PRIMARY) %>%
  transform(primary_income = ifelse(primary_income < 0, 0, primary_income)) %>%
  group_by(PRIMARY,WAVE) %>%
  summarise(index = ineq(primary_income,type = c("Gini")))

ggplot(gini.years.primary,aes(x = WAVE,y = index,group = PRIMARY,color = PRIMARY)) +
  geom_line()+
  #geom_point()+
  ggtitle("Gini Index Over Year by Primary Outcome") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(gini.years.primary,aes(x = WAVE,y = index)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~PRIMARY)
```

```{r ineq4}
gini.years.urban = df %>%
  dplyr::select(HHID,primary_income,T1,WAVE,URBAN) %>%
  transform(primary_income = ifelse(primary_income < 0, 0, primary_income)) %>%
  group_by(URBAN,WAVE) %>%
  summarise(index = ineq(primary_income,type = c("Gini")))

ggplot(gini.years.urban,aes(x = WAVE,y = index,group = URBAN,color = URBAN)) +
  geom_line()+
  #geom_point()+
  ggtitle("Gini Index Over Year by Urban/Rural") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r ratio1}
ratio.years = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE,city) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(bottom10)/sum(top10),sumb = sum(bottom10),sumt =sum(top10))

ggplot(ratio.years,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  geom_text(aes(label = round(ratio, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r ratio2}
ratio.years.province = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE,city) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE,city) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(bottom10)/sum(top10),sumb = sum(bottom10),sumt =sum(top10))

ggplot(ratio.years.province,aes(x = WAVE,y = ratio,group = city,color = city)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(ratio.years.province,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~city)
```

```{r ratio3}
ratio.years.primary = df %>%
  dplyr::select(HHID,HHINCPC_CPI,WAVE,PRIMARY) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE,PRIMARY) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(bottom10)/sum(top10),sumb = sum(bottom10),sumt =sum(top10))

ggplot(ratio.years.primary,aes(x = WAVE,y = ratio,group = PRIMARY,color = PRIMARY)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(ratio.years.primary,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~PRIMARY)
```

# Beta coefficient test
```{r}
library(gridExtra)
coefs <- names(fixef(final_model))
#year
coeftest_year <- linearHypothesis(final_model, "CYEAR=0")
#urban/rural
coeftest_urban <- linearHypothesis(final_model, "URBAN1=0")
#province
coeftest_province <- linearHypothesis(final_model, coefs[4:14])
#primary
coeftest_primary <- linearHypothesis(final_model, coefs[15:21])
#year:primary
coeftest_yearprimary <- linearHypothesis(final_model, coefs[22:28])
#year:urban
coeftest_yearurban <- linearHypothesis(final_model, coefs[29])
#year:province
coeftest_yearprovince <- linearHypothesis(final_model, coefs[30:40])
#urban:province
coeftest_urbanprovince <- linearHypothesis(final_model, coefs[41:51])
 

coeftest <- na.omit(rbind(coeftest_year, coeftest_urban, coeftest_province, coeftest_primary, coeftest_yearprimary, coeftest_yearurban, coeftest_yearprovince, coeftest_urbanprovince))
var <- c("Year","Urban", "Province", "Primary Income Source", "Year:Primary Source", "Year:Urban", "Year:Province", "Urban:Province")
coeftest <- cbind(var, coeftest)
kable(coeftest, col.names = c("Variable", "Degrees of Freedom", "Chi-squared", "p-value"), caption="Hypothesis Testing of Urban Coefficients",align="c")

png("beta-test.png")
p <- tableGrob(coeftest)
grid.arrange(p)
dev.off()
```

#Variation in household income by province
```{r}
yrs <- c(0,2,4,8,11,15,17,20,22,26)
xvar <- c("1989", "1991", "1993", "1997", "2000", "2004", "2006", "2009", "2011", "2015")
estimate <- as.data.frame(summary(final_model)$coefficients)
estimate <- estimate %>% dplyr::select(Estimate)

for (i in yrs) {
  prov21 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T121",]+yrs*estimate["CYEAR:T121",]
  df7 <- data.frame(prov21)
}
for (i in yrs) {
  prov23 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T123",]+yrs*estimate["CYEAR:T123",]
  df8 <- data.frame(prov23)
}
for (i in yrs) {
  prov31 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T131",]+yrs*estimate["CYEAR:T131",]
  df9 <- data.frame(prov31)
}
for (i in yrs) {
  prov32 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T132",]+yrs*estimate["CYEAR:T132",]
  df10 <- data.frame(prov32)
}
for (i in yrs) {
  prov37 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T137",]+yrs*estimate["CYEAR:T137",]
  df11 <- data.frame(prov37)
}
for (i in yrs) {
  prov41 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T141",]+yrs*estimate["CYEAR:T141",]
  df12 <- data.frame(prov41)
}
for (i in yrs) {
  prov42 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T142",]+yrs*estimate["CYEAR:T142",]
  df13 <- data.frame(prov42)
}
for (i in yrs) {
  prov43 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T143",]+yrs*estimate["CYEAR:T143",]
  df14 <- data.frame(prov43)
}
for (i in yrs) {
  prov45 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T145",]+yrs*estimate["CYEAR:T145",]
  df15 <- data.frame(prov45)
}
for (i in yrs) {
  prov52 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T152",]+yrs*estimate["CYEAR:T152",]
  df16 <- data.frame(prov52)
}
for (i in yrs) {
  prov55 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["T155",]+yrs*estimate["CYEAR:T155",]
  df17 <- data.frame(prov55)
}
for (i in yrs) {
  prov11 <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]
  df18 <- data.frame(prov11)
}

prov.data <- cbind(xvar, df18, df7, df8, df9, df10, df11, df12, df13, df14, df15, df16, df17)
prov.data$xvar <- as.numeric(as.character(prov.data$xvar))
mdf2 <- melt(prov.data, id.vars="xvar")

plot2 <- ggplot(mdf2, aes(x=xvar, y=value, group=variable, color=variable)) + 
  geom_line() +
  geom_point() +
  scale_color_discrete(name="Province",
                       labels=c("Beijing", "Liaoning", "Heilongjiang", "Shanghai", "Jiangsu", "Shandong", "Henan", "Hubei", "Hunan", "Guangxi", "Guizhou", "Chongqing")) +
  labs(title="Changes in Household Income per Capita Over Time \nby Province",
       x="Year",
       y="Beta coefficients") +
    theme(plot.title = element_text(size=20))
```

#Variation in household income by urban/rural status
```{r}
for (i in yrs) {
  urb <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["URBAN1",]+estimate["URBAN1:CYEAR",]
  df19 <- data.frame(urb)
}
for (i in yrs) {
  rur <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]
  df20 <- data.frame(rur)
}

urb.data <- cbind(xvar, df19, df20)
urb.data$xvar <- as.numeric(as.character(urb.data$xvar))
mdf3 <- melt(urb.data, id.vars="xvar")

plot3 <- ggplot(mdf3, aes(x=xvar, y=value, group=variable, color=variable)) +
  geom_line() +
  geom_point() +
  scale_color_discrete(name="Status",
                       labels=c("Urban", "Rural")) +
  labs(title="Changes in Household Income per Capita Over Time \nby Urban/Rural Status",
       x="Year",
       y="Beta coefficients") +
  theme(plot.title = element_text(size=20))
```

#Variation in household income by income source
```{r}
for (i in yrs) {
  bus <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]
  d <- data.frame(bus)
}

for (i in yrs) {
  farm <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHFARM",]+yrs*estimate["CYEAR:PRIMARYHHFARM",]
  df0 <- data.frame(farm)
}

for (i in yrs) {
  fish <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHFISH",]+yrs*estimate["CYEAR:PRIMARYHHFISH",]
  df1 <- data.frame(fish)
}

for (i in yrs) {
  gard <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHGARD",]+yrs*estimate["CYEAR:PRIMARYHHGARD",]
  df2 <- data.frame(gard)
}

for (i in yrs) {
  lvst <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHLVST",]+yrs*estimate["CYEAR:PRIMARYHHLVST",]
  df3 <- data.frame(lvst)
}

for (i in yrs) {
  othr <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHOTHR",]+yrs*estimate["CYEAR:PRIMARYHHOTHR",]
  df4 <- data.frame(othr)
}

for (i in yrs) {
  retire <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHRETIRE",]+yrs*estimate["CYEAR:PRIMARYHHRETIRE",]
  df5 <- data.frame(retire)
}

for (i in yrs) {
  sub <- estimate["(Intercept)",]+yrs*estimate["CYEAR",]+estimate["PRIMARYHHSUB",]+yrs*estimate["CYEAR:PRIMARYHHSUB",]
  df6 <- data.frame(sub)
}

source.data <- cbind(xvar, d, df0, df1, df2, df3, df4, df5, df6)
source.data$xvar <- as.numeric(as.character(source.data$xvar))
mdf1 <- melt(source.data, id.vars="xvar")

plot1 <- ggplot(mdf1, aes(x=xvar, y=value, group=variable, color=variable)) + 
  geom_line(aes(color=variable)) +
  geom_point() +
  scale_color_discrete(name="Income Source",
                       labels=c("Business","Farming", "Fishing", "Gardening", "Livestock", "Others", "Retirement", "Subsidies")) +
  labs(title="Changes in Household Income per Capita Over Time \nby Primary Income Source",
       x="Year",
       y="Beta coefficients") +
    theme(plot.title = element_text(size=20))
```
