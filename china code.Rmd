---
title: "chinacode"
author: "Sherry Hu"
date: "5/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(mice)
library(reshape2)
library(ggplot2)
library(lme4)
library(lattice)
library(caret)
library(monomvn)
library(ineq)

# read in data
require(haven)
sashhinc=read_sas("hhinc_10.sas7bdat")

# let's make this more interpretable by letting 1989 be year 0
# also let's convert income to thousands of yuan
sashhinc$cyear=sashhinc$WAVE-1989
sashhinc$thousands=sashhinc$hhincpc_cpi/1000

# replace NAs w/ null
sashhinc[is.na(sashhinc)] = 0

## .1% removed- put in sashhinc_trimmed df
lower = quantile(sashhinc$thousands, 0.001)
upper = quantile(sashhinc$thousands, 0.999)
sashhinc_trimmed = subset(sashhinc, lower < thousands & thousands < upper)

# log transform
sashhinc$thousands_shifted=sashhinc$thousands - (min(sashhinc$thousands)-0.01)

# change to categorical variables
sashhinc$urban <- as.factor(sashhinc$urban)
sashhinc$hhid <- as.factor(sashhinc$hhid)
sashhinc$t1 <- as.factor(sashhinc$t1)
```

```{r}
# take a peek at dataset
colnames(sashhinc)
summary(sashhinc)
```

```{r data_cleaning}
# select variables we need for df
df = dplyr::select(sashhinc,
            hhid,
            WAVE,
            hhinc_cpi, 
            hhincpc_cpi, 
            HHBUS, 
            HHBUSimp, 
            HHFARM, 
            HHFARMimp, 
            HHFISH, 
            HHFISHimp, 
            hhgard, 
            HHGARDimp,
            HHLVST,
            HHLVSTimp,
            hhNRwage,
            HHNRWAGEimp,
            HHOTHR,
            HHOTHRimp,
            HHRETIRE,
            HHRETIREimp,
            HHSUB,
            HHSUBimp,
            t1,
            urban,
            thousands,
            cyear,
            thousands_shifted)

names(df)<- toupper(names(df))

#add primary income source variable
df <- df %>% 
        mutate(Primary = colnames(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")])[apply(df[, c("HHBUS", "HHFARM", "HHFISH", "HHGARD", "HHLVST", "HHOTHR", "HHRETIRE", "HHSUB")], 1, which.max)])

# select variables we need for df w/o outliers
df_trimmed = dplyr::select(sashhinc,
            hhid,
            WAVE,
            hhinc_cpi, 
            hhincpc_cpi, 
            HHBUS, 
            HHBUSimp, 
            HHFARM, 
            HHFARMimp, 
            HHFISH, 
            HHFISHimp, 
            hhgard, 
            HHGARDimp,
            HHLVST,
            HHLVSTimp,
            hhNRwage,
            HHNRWAGEimp,
            HHOTHR,
            HHOTHRimp,
            HHRETIRE,
            HHRETIREimp,
            HHSUB,
            HHSUBimp,
            t1,
            urban,
            thousands,
            cyear,
            thousands_shifted)

names(df)<- toupper(names(df))
df$T1 = as.factor(df$T1)

names(df_trimmed)<- toupper(names(df_trimmed))
df_trimmed$T1 = as.factor(df_trimmed$T1)

head(df)
head(df_trimmed)
```

```{r ineq1}
#gini index overtime
gini.years = df %>%
  select(HHID,HHINCPC_CPI,WAVE) %>%
  arrange(HHINCPC_CPI) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(WAVE) %>%
  summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

ggplot(gini.years,aes(x = WAVE,y = index)) +
  geom_line() +
  geom_point()+
  geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

years = c(1989,1991,1993,1997,2000,2004,2006,2009,2011,2015)
plot(Lc(df[df$WAVE ==1989,]$HHINCPC_CPI),col="darkred",lwd=2)
for (i in 2:length(years)){
  lines(Lc(df[df$WAVE ==years[i],]$HHINCPC_CPI),col="darkred",lwd=2)
}
lines(Lc(df[df$WAVE ==1991,]$HHINCPC_CPI),col="darkred",lwd=2)

```

```{r ineq2}
#gini index overtime and provinces
df =  df %>%
  mutate(city = case_when(T1 == 11 ~ "Beijing",
                          T1 == 21  ~ "LiaoNing",
                          T1 == 23  ~ "Heilongjiang",
                          T1 == 31  ~ "Shanghai",
                          T1 == 32  ~ "Jiangsu",
                          T1 == 33  ~ "Zhejiang",
                          T1 == 37  ~ "Shandong",
                          T1 == 41  ~ "Henan",
                          T1 == 42  ~ "Hubei",
                          T1 == 43  ~ "Hunan",
                          T1 == 45  ~ "Guangxi",
                          T1 == 52  ~ "Guizhou",
                          T1 == 53  ~ "Yunnan",
                          T1 == 55  ~ "Chongqing",
                          T1 == 61  ~ "Shanxi"))

gini.years.province = df %>%
  select(HHID,HHINCPC_CPI,T1,WAVE,city) %>%
  #arrange(HHINCPC_CPI) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(city,WAVE) %>%
  summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

ggplot(gini.years.province,aes(x = WAVE,y = index,group = city,color = city)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r ineq3}
gini.years.primary = df %>%
  select(HHID,HHINCPC_CPI,T1,WAVE,city,PRIMARY) %>%
  transform(HHINCPC_CPI = ifelse(HHINCPC_CPI < 0, 0, HHINCPC_CPI)) %>%
  group_by(PRIMARY,WAVE) %>%
  summarise(index = ineq(HHINCPC_CPI,type = c("Gini")))

ggplot(gini.years.primary,aes(x = WAVE,y = index,group = PRIMARY,color = PRIMARY)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(gini.years.primary,aes(x = WAVE,y = index)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~PRIMARY)
```

```{r ratio1}
ratio.years = df %>%
  select(HHID,HHINCPC_CPI,WAVE,city) %>%
  group_by(WAVE) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(bottom10)/sum(top10),sumb = sum(bottom10),sumt =sum(top10))

ggplot(ratio.years,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  geom_text(aes(label = round(ratio, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r ratio2}
ratio.years.province = df %>%
  select(HHID,HHINCPC_CPI,WAVE,city) %>%
  group_by(WAVE,city) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(bottom10)/sum(top10),sumb = sum(bottom10),sumt =sum(top10))

ggplot(ratio.years.province,aes(x = WAVE,y = ratio,group = city,color = city)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(ratio.years.province,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~city)
```

```{r ratio3}
ratio.years.primary = df %>%
  select(HHID,HHINCPC_CPI,WAVE,PRIMARY) %>%
  group_by(WAVE,PRIMARY) %>%
  mutate(top10 = ifelse(HHINCPC_CPI >= quantile(HHINCPC_CPI,0.9),HHINCPC_CPI,0),
        bottom10 = ifelse(HHINCPC_CPI <= quantile(HHINCPC_CPI,0.1),HHINCPC_CPI,0)) %>%
  summarise(ratio = sum(bottom10)/sum(top10),sumb = sum(bottom10),sumt =sum(top10))

ggplot(ratio.years.primary,aes(x = WAVE,y = ratio,group = PRIMARY,color = PRIMARY)) +
  geom_line()+
  geom_point()+
  ggtitle("Gini Index Over Year by Province") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(ratio.years.primary,aes(x = WAVE,y = ratio)) +
  geom_line() +
  geom_point()+
  #geom_text(aes(label = round(index, 3),hjust = -0.3,vjust = 0.5)) +
  ggtitle("Gini Index Over Year") +
  xlab("Year") + ylab("Gini Index") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(~PRIMARY)
```

# Model w/ outliers 
```{r}
colnames(df)
``` 

```{r}
# fit model with all interactions
m1 = lmer(log(thousands_shifted) ~ CYEAR + URBAN + T1 + 
          CYEAR*URBAN 
          + CYEAR*T1 + URBAN*T1 + CYEAR*URBAN*T1
        + (1 + CYEAR|HHID), data=df)
summary(m1)
anova(m1)
```

# Model selection- m1 (outliers included)
```{r}
# using BMA 
# moving response to first column 
df <- df %>% dplyr::select(THOUSANDS_SHIFTED, everything())

library(BMS)
#bms(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + 
 #        CYEAR*URBAN + CYEAR*T1 + URBAN*T1 + CYEAR*URBAN*T1 + (1 + CYEAR|HHID), data=df)
bms(df)
```

```{r}
extract_b <- function(m) c(mean(m$mu), colMeans(m$beta)) # Bayes estimators (posterior mean)

df$urban_year_interaction = df$URBAN * df$CYEAR
# df$urban_year_interaction_2 = df$URBAN_2 * df$CYEAR

# indicator for provinces , random effects for intercept 
# slope would be same indicators times 
# + (1 + CYEAR|HHID)
# df$T1 * identity matrix, do left join, 

# to add time component, you would mutate add to identity matrix 

df$HHID = as.factor(df$HHID)
# Note: we are using the whole dataset for now, not the train-test split 
df_X = df %>% dplyr::select(CYEAR, HHID, T1, URBAN, Z*b_i)
df_Y = df %>% pull(THOUSANDS_SHIFTED)
m1 <- bhs(df_X, df_Y)
b_hat_hs <- extract_b(m1)
# Y_hat_hs <- my_predict(b_hat_hs, X = X_test)
```

```{r}
library(tidyverse)
library(caret)
library(leaps)
# stepwise 
# step.model <- stepAIC(m1, direction = "both", trace = FALSE)
```

# Model w/o Outliers
```{r}
# fit model with all interactions
m2=lmer(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + 
          CYEAR*URBAN + CYEAR*T1 + URBAN*T1 + CYEAR*URBAN*T1
        + (1 + CYEAR|HHID), data=df_trimmed)
summary(m2)
anova(m2)
```

# Model selection using horseshoe prior (m2- w/0 outliers)
```{r}
# Note: we are using the whole dataset for now, not the train-test split 
df_trim_X = df_trimmed %>% dplyr::select(CYEAR, HHID, T1, URBAN)
df_trim_Y = df_trimmed %>% pull(THOUSANDS_SHIFTED)
m2 <- bhs(df_trim_X, df_trim_Y)
b_hat_hs_trim <- extract_b(m2)
# Y_hat_hs <- my_predict(b_hat_hs, X = X_test)
```

```{r}
print(b_hat_hs)
print(b_hat_hs_trim)
```

# Residual plots post var. selection
```{r}
qqmath(resid(m1))
plot(m1,resid(.,scaled=TRUE)~fitted(.),abline=0)

qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0)
```

# other stuff 

# cross validation

```{r}
HHIDs = unique(df$HHID)

# do random sampling
n_times = 10

# 80 - 20 test split
test_size = 5 

MSEs = c()
for(i in 1:n_times){
  set.seed(i)
  
  # split into train and test folds
  test_indices = seq(i, length(HHIDs), test_size)
  train_fold_HHIDs = HHIDs[-test_indices]
  test_fold_HHIDs = HHIDs[test_indices]
  
  train_fold = df[df$HHID %in% train_fold_HHIDs,]
  test_fold = df[df$HHID %in% test_fold_HHIDs,]
  
  #create a new model on train_fold
  our_model = lmer(HHINCPC_CPI ~  CYEAR + URBAN + T1 + 
          CYEAR*URBAN + CYEAR*T1 + URBAN*T1
        + CYEAR*URBAN*T1 +
          (1|HHID), data=train_fold)
  
  predictions = predict(our_model, test_fold, allow.new.levels=TRUE)
  residuals = (predictions) - (test_fold$HHINCPC_CPI)
  MSE = mean(residuals^2)
  MSEs = c(MSEs, MSE)
}

```

```{r}
MSEs
```

```{r}
mean(MSEs)
sd(MSEs)
```


```{r}
df <- df %>% dplyr::select(THOUSANDS_SHIFTED, everything())

library(BMS)
#bms(log(THOUSANDS_SHIFTED) ~ CYEAR + URBAN + T1 + 
 #        CYEAR*URBAN + CYEAR*T1 + URBAN*T1 + CYEAR*URBAN*T1 + (1 + CYEAR|HHID), data=df)
bms(df)
```

```{r}
df$cyear=df$WAVE-1989
df$thousands=df$HHINC_CPI/1000

m2=lmer(HHINC_CPI ~  HHBUS + HHFARM + HHFISH + HHGARD + HHLVST + HHNRWAGE + HHOTHR  + HHRETIRE + HHSUB + 
          (1|HHID), data=df)
summary(m2)
anova(m2)
```

```{r}
mean(MSEs)
```


# old stuff

```{r}
sashhinc$cyear=sashhinc$WAVE-1989
sashhinc$thousands=sashhinc$hhinc_cpi/1000
```

pairs(log(thousands_shifted)~cyear + urban + t1, data=sashhinc)
```

```{r}

m2=lmer(log(thousands_shifted) ~ cyear + urban + t1 + 
          cyear*urban + cyear*t1 + urban*t1 
        + cyear*urban*t1 + (1|hhid),data=sashhinc, REML=FALSE)
summary(m2)
```

```{r}
# ggplot(sashhinc, aes(x=cyear,y=thousands,group=hhid)) +
#   ylim(-500,1500) + 
#   geom_point(alpha=0.05) + geom_line(alpha=0.1) +
#   geom_abline(data=est, aes(intercept=int, slope=sl),col="red") +
#   xlab("Years Since 1989") + ylab("Income (thousands of yuan)") + 
#   ggtitle("CHNS Household Income by Year")

```


## .1% removed
```{r}
lower = quantile(sashhinc$thousands, 0.001)
upper = quantile(sashhinc$thousands, 0.999)
sashhinc_trimmed = subset(sashhinc, lower < thousands & thousands < upper)
dim(sashhinc)[1] - dim(sashhinc_trimmed)[1]
```

```{r}
m2=lmer((thousands) ~ cyear + urban + t1 + 
          cyear*urban + cyear*t1 + urban*t1 
        + cyear*urban*t1 + (1|hhid),data=sashhinc_trimmed, REML=FALSE)
summary(m2)
```


```{r}
qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0)

```



```{r}
sashhinc_trimmed$thousands_shifted = sashhinc_trimmed$thousands - (min(sashhinc_trimmed$thousands)-0.01)
m2=lmer(log(thousands_shifted) ~ cyear + urban + t1 + 
          cyear*urban + cyear*t1 + urban*t1 
        + cyear*urban*t1 + (1|hhid),data=sashhinc_trimmed, REML=FALSE)
summary(m2)
```


```{r}
qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0)
```

## .05% removed

```{r}
lower = quantile(sashhinc$thousands, 0.005)
upper = quantile(sashhinc$thousands, 0.995)
sashhinc_trimmed = subset(sashhinc, lower < thousands & thousands < upper)
dim(sashhinc)[1] - dim(sashhinc_trimmed)[1]
```

```{r}
m2=lmer((thousands) ~ cyear + urban + t1 + 
          cyear*urban + cyear*t1 + urban*t1 
        + cyear*urban*t1 + (1|hhid),data=sashhinc_trimmed, REML=FALSE)
summary(m2)
```


```{r}
qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0)

```



```{r}
sashhinc_trimmed$thousands_shifted = sashhinc_trimmed$thousands - (min(sashhinc_trimmed$thousands)-0.01)
m2=lmer(log(thousands_shifted) ~ cyear + urban + t1 + 
          cyear*urban + cyear*t1 + urban*t1 
        + cyear*urban*t1 + (1|hhid),data=sashhinc_trimmed)
summary(m2)
```


```{r}
qqmath(resid(m2))
plot(m2,resid(.,scaled=TRUE)~fitted(.),abline=0)
```